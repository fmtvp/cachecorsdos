<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CORS Cache Poisoning Demo - LifeStyle Blog</title>
    <style>
        body { font-family: Arial, sans-serif; max-width: 800px; margin: 0 auto; padding: 20px; }
        .container { background: #f5f5f5; padding: 20px; border-radius: 8px; margin: 20px 0; }
        button { background: #007cba; color: white; padding: 10px 20px; border: none; border-radius: 4px; cursor: pointer; margin: 5px; }
        button:hover { background: #005a87; }
        .output { background: white; padding: 15px; border-radius: 4px; margin: 10px 0; border-left: 4px solid #007cba; }
        .error { border-left-color: #dc3232; }
        .success { border-left-color: #46b450; }
        .blog-link { display: inline-block; background: #667eea; color: white; padding: 10px 20px; text-decoration: none; border-radius: 4px; margin: 10px 0; }
        .blog-link:hover { background: #5a67d8; }
    </style>
</head>
<body>
    <h1>CORS Cache Poisoning Vulnerability Demo</h1>
    
    <a href="/" class="blog-link">‚Üê Back to LifeStyle Blog</a>
    
    <div class="container">
        <h2>Step 1: Poison the Cache</h2>
        <p>This will make requests from this origin and poison the cache with this site's origin header.</p>
        <button onclick="poisonCache()">Poison Cache (Execute 5-10 times)</button>
        <div id="poison-output"></div>
    </div>

    <div class="container">
        <h2>Step 2: Test from Different Origin</h2>
        <p>Open the external test page in a different browser tab to see the CORS error.</p>
        <a href="/external.html" target="_blank" style="background: #dc3232; color: white; padding: 10px 20px; text-decoration: none; border-radius: 4px;">Open External Test Page</a>
        <div id="cors-output"></div>
    </div>

    <div class="container">
        <h2>Step 3: Clear Cache</h2>
        <p>Clear the server cache to reset the demonstration.</p>
        <button onclick="clearCache()">Clear Cache</button>
        <div id="clear-output"></div>
    </div>

    <div class="container">
        <h2>Vulnerability Explanation</h2>
        <p>This demonstrates how a WordPress.com-like API can be vulnerable to CORS cache poisoning:</p>
        <ul>
            <li>The server echoes the Origin header in Access-Control-Allow-Origin</li>
            <li>Responses are cached without considering the Origin header in the cache key</li>
            <li>Subsequent requests from different origins receive the wrong CORS header</li>
            <li>This causes CORS failures and denial of service</li>
        </ul>
    </div>

    <script>
        let poisonCount = 0;

        async function poisonCache() {
            poisonCount++;
            const output = document.getElementById('poison-output');
            
            try {
                const response = await fetch('/wp-json/wp/v2/posts?demo=poison' + poisonCount);
                const data = await response.json();
                const cacheStatus = response.headers.get('X-Cache') || 'unknown';
                const corsHeader = response.headers.get('Access-Control-Allow-Origin') || 'none';
                
                output.innerHTML += `
                    <div class="output success">
                        <strong>Poison Attempt ${poisonCount}:</strong><br>
                        Cache Status: ${cacheStatus}<br>
                        CORS Header: ${corsHeader}<br>
                        Origin: ${window.location.origin}<br>
                        Posts loaded: ${data.length}
                    </div>
                `;
            } catch (error) {
                output.innerHTML += `
                    <div class="output error">
                        <strong>Error:</strong> ${error.message}
                    </div>
                `;
            }
        }

        async function clearCache() {
            const output = document.getElementById('clear-output');
            
            try {
                const response = await fetch('/clear-cache', { method: 'POST' });
                output.innerHTML = `
                    <div class="output success">
                        Cache cleared successfully. You can now restart the demonstration.
                    </div>
                `;
                poisonCount = 0;
                document.getElementById('poison-output').innerHTML = '';
                document.getElementById('cors-output').innerHTML = '';
            } catch (error) {
                output.innerHTML = `
                    <div class="output error">
                        <strong>Error:</strong> ${error.message}
                    </div>
                `;
            }
        }
    </script>
</body>
</html>
